---
title: "Savannah Germination"
author: "Katie Heineman"
date: "5/10/2019"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(car)
library(ggplot2)
library(ape)
library(phytools)
library(phylolm)
library(stringr)
library(readr)

## Making the tree- Doesn't seem to work with Ubuntu this version because it doesn't have the right version of R
# if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install()
#biocLite("ggtree")
#library(ggtree)


# Ana's seed database
seedDat <- fread("Data/Savanna seed database.csv")

```


# Building New Phylogeny using PhyloMakeR

S.Phylomater produces phylogenies using three scenarios. This function & method were described in Qian & Jin 2016 in Journal of Ecology.

1. adding genera or species as basal polytomies within their families or genera 
2. adding genera or species randomly within their families or genera 
3. adding genera or species to their families or genera using the same approach implemented in Phylomatic and BLADJ 

There is also a newer function called VPhyloMaker is supposed to be faster and perhaps use a more up to date phylogeny?

```{r new phylogeny}
## Practice using the tool with example data
# Source the code from Qian & Jin 2016 paper
source("R_codes for S.PhyloMaker.R")
# Read in the example list
# example_splist <- na.omit(as.data.frame(read_delim("example.splist.csv", "\t", escape_double = FALSE, trim_ws = TRUE)))
# # Read in the megaphylogeny
 phylo<-read.tree("Data/PhytoPhylo.tre") # read in the megaphylogeny.
 nodes <- as.data.table(read_delim("Data/nodes.csv", "\t", escape_double = FALSE,  trim_ws = TRUE))
# # Run the phylogeny for two "scenarios"
# result<-S.PhyloMaker(spList=example_splist, tree=phylo, nodes=nodes, scenarios=c("S1","S2")) # For some reason scenario S3 doesn't work

## Making species list for Ana's species
Spp <- seedDat[,.(Count=.N),by="Species"]
Spp[,genus:=word(Species,1,1),by="Species"]

## Finding Family's from genera from phylomaker Nodes file
genusTable = nodes[,.(family=family[1]),by="genus"]

## Merge families onto genus
Spp <- merge(Spp,genusTable,by="genus",all.x=T)
Spp[genus=="Eremanthus", family:="Asteraceae"]
setnames(Spp,"Species","species")
Spp <- Spp[,.(species,genus,family)]

## Bulding Tree for all three scenarios
result_ana_S3 <- S.PhyloMaker(spList=as.data.frame(Spp), tree=phylo, nodes=nodes, scenarios=c("S1","S2","S3")) 

## Comparing scenarios
plot(result_ana_S3$Scenario.1, main="Scenario 1 (basal polytomies)")
plot(result_ana_S3$Scenario.2,main="Scenario 2 (random placement)")
plot(result_ana_S3$Scenario.3,main="Scenario 3 (Bladj & Phylocom)")


## TREE SCENARIO 3
phy_coll3 <- collapse.singles(result_ana_S3$Scenario.3)
# Naming the internal nodes so that the following inverse function works
phy_coll3$node.label[which(phy_coll3$node.label=="")]=paste0("unknownNode",seq(1:(length(which(phy_coll3$node.label=="")))))
# This does somethign to make the tree ultrametric
phy_coll3 <- chronoMPL(phy_coll3)
write.tree(phy_coll3,"Data/phy_coll3.tre")


## TREE SCENARIO 1
phy_coll1 <- collapse.singles(result_ana_S3$Scenario.1)
# Naming the internal nodes so that the following inverse function works
phy_coll1$node.label[which(phy_coll1$node.label=="")]=paste0("unknownNode",seq(1:(length(which(phy_coll1$node.label=="")))))
# This does somethign to make the tree ultrametric
phy_coll1 <- chronoMPL(phy_coll1)
write.tree(phy_coll1,"Data/phy_coll1.tre")

## TREE SCENARIO 2
phy_coll2 <- collapse.singles(result_ana_S3$Scenario.2)
# Naming the internal nodes so that the following inverse function works
phy_coll2$node.label[which(phy_coll2$node.label=="")]=paste0("unknownNode",seq(1:(length(which(phy_coll2$node.label=="")))))
# This does somethign to make the tree ultrametric
phy_coll2 <- chronoMPL(phy_coll2)
write.tree(phy_coll2,"Data/phy_coll2.tre")

```



```{r multicore code}

# ## FULL Bayesian model multiple regression model for T50
# setCores<-round(detectCores()*0.8)
# cl <- makeCluster(getOption("cl.cores",setCores))
# cl.pkg <- clusterEvalQ(cl,library(MCMCglmm)) 
# clusterExport(cl,"prior")
#   clusterExport(cl,"test.data")
#   clusterExport(cl,"Ainv")
#  model2_10runs<-parLapply(cl=cl,1:10, function(i) {
#     MCMCglmm(phenotype~1, random=~taxon, ginverse=list(taxon=Ainv),
#              data=test.data, prior=prior, verbose=FALSE, 
#              nitt=100000, burnin=10000, thin=10)}
#   )
#   
# # once it's finished, use stopCluster() to stop running the parallel cluster
# stopCluster(cl)
# summary(model2_10runs[[3]]) # summarize the third model out of the 10
# 
# 
# cl <- makeCluster(getOption("cl.cores",setCores))
# 


```
# Distribution of Species mean T50 on Phylogeny
```{r phylogenetic tree graph T50}

# Data Table called tip order for Family Tree
TipOrder = data.table(Tip=phy_coll$tip.label)
# Making a new column that says the order of the tips in the phylogeny
TipOrder[,TipOrder:=.I]

inputData = merge(seedDat_spp,TipOrder,by.x="Species",by.y="Tip",all.x=T)[order(TipOrder)]

phy_coll$tip.label <- paste0(inputData$Species, " (" ,inputData$T50_mean," days)")

p <- ggtree(phy_coll,layout='rectangular') + geom_tiplab( size=3, color="black",offset=3)
p <- p + xlim(0,200)
p <- p +geom_tippoint(aes(x=x), size=(inputData$T50_mean)/10)
p <- p + ggtitle("Species Mean T50")
p
```


# Distribution of Species mean Germination Percent on Phylogeny
```{r phylogenetic tree graph T50}

phy_coll$tip.label <- paste0(inputData$Species, " (" ,inputData$GP,"%)")

p <- ggtree(phy_coll,layout='rectangular') + geom_tiplab( size=3, color="black",offset=3)
p <- p + xlim(0,200)
p <- p +geom_tippoint(aes(x=x), size=(inputData$GP)/10)
p <- p + ggtitle("Species Mean GP")
p
```
# Distribution of Species mean Seed Mapps on Phylogeny
```{r phylogenetic tree graph T50}

phy_coll$tip.label <- paste0(inputData$Species, " (" ,inputData$Seedmass,"mg)")

p <- ggtree(phy_coll,layout='rectangular') + geom_tiplab( size=3, color="black",offset=3)
p <- p + xlim(0,200)
p <- p +geom_tippoint(aes(x=x), size=sqrt(inputData$Seedmass/2))
p <- p + ggtitle("Species Mean GP")
p
```
